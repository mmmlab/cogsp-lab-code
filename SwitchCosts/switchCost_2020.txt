#Switch Cost
# C. Aitkin February 2020 so would run on PsychoPy 3 on Mac OS catalina
#Jason 8/11/2016: fixed typo in writing results file: == instead of = when writing 'low' or 'even'
# also uResponse instead of userResponse on the same lines
#Christina July 2016
#Based on Monsell, Sumner, and Waters, Memory and Cognition 2003. 31(3) 327 - 342
#Each trial: one number is displayed, either red or green. If the given number is red
#the user must response as to whether it is an odd or even number, if the given numbers
#is green then the user must respond as to whether or not it is higher or lower than 5
#Each experiment is either predictable (changes color and task every 5) or unpredictable
#(color changes at random)

from psychopy import visual, core, gui, data, event, sound
from psychopy.tools.filetools import fromFile, toFile
import time, numpy, random, string, scipy
import csv
#import xlwt


global mywin
global grating
global fixation
global blankletter
global centraltext
global xecc,yecc
global savetilt


# set up the menu for choice of conditions
myDlg = gui.Dlg(title="Switch Cost",size=(1, 1))
myDlg.addField('Initials:','xx')
myDlg.addField('SessionNumber:',1)
myDlg.addField('NumberofTrials',30)
myDlg.addField('Intertrial Time ', 2)
myDlg.addField('Type of Task (U or P)')
myDlg.show()
if myDlg.OK:
    sessioninfo=myDlg.data
else:
    print('cancelled') #Changed print 'cancelled' to print('cancelled')
    
#read values from menu and put in variables
idn=sessioninfo[0] # Sets idn equal to initials
sessnumber=sessioninfo[1] #sets equal to Session nummber
ntrials=sessioninfo[2] #sets n trial equal to number of trials
intertrialTime=sessioninfo[3]#sets equal to intertrial time
tasktype=sessioninfo[4] 


actual = [] #the correct response
response = [] # given response by the user
digitcolor = [] # color of the digit
numValue = [] # value of the number
taskstore = []#the task being performed at a given instant
rTime = [] #reaction times for each experiment
lettPress = [] #the letter the subject pressed


#filename
filename=''
filename='Switchcost'
filename+=idn
filename+='_'+str(sessnumber)
filename+='_'+data.getDateStr()
print(filename) #Changed from print filename to print('filename')
datetime=data.getDateStr()

#window #*******************************Question Default Screen Color
mywin = visual.Window([800,600], monitor="testMonitor", units="pix")
#rgb=[-1,-1,-1] makes screen black
random.seed()  #initializes by reading the time

global digitVal
global digitColor
global endAnswer



endAnswer = 0
numbers = [ 1, 2 , 3, 4, 6, 7, 8, 9]
colors = ['Red', 'Green'] #two uses, to set the color on the display screen and also to choose the first color of the pred sequence

def blankscreen():
    
    mywin.flip(clearBuffer=True)
    mywin.flip()
 #   print pause/1000.0
    
    
def displaysometext(texttodisplay):
    prompt=visual.TextStim(win=mywin, text=texttodisplay,pos=[0,0],rgb=2,contrast=1)
    prompt.draw()
    mywin.flip()
    
dataForFile = [("Trial",
"Task",
"Actual",
"Response",
"Reaction Time",
"Number Shown",
"Letter Pressed",
)]    
    
    #write csv file with results
def write_file(filename):
    

#below is info for each trial

    for i in range (0, ntrials): 
        dataForFile.append((i+1, taskstore[i], actual[i], response[i], float("%8.3f"%rTime[i]), numValue[i], lettPress[i]))
        with open('%s.csv' %(filename), 'w') as fp:
            writer = csv.writer(fp, delimiter=',' )
            writer.writerows(dataForFile)
    


def getresponse():
    k = event.waitKeys()
    event.clearEvents()
    b=k[0]
    if b=='escape':  #option to get out
        mywin.close()
        core.quit()
    return b


def responseCheck(chosenColor, digitVal):#Where responses are checked and recorded
    global uResp
    uResp = 0
    userResp = 0
    userResponse = 0
                        
    if chosenColor == 'Green':
        while userResponse not in ['a','l']:
            userResponse=getresponse() 
                                

            currentTime = reactionTime.getTime()
            rTime.append(currentTime)                    
            print(reactionTime) #Changed from print reactionTime to print(reactionTime)
            reactionTime.reset = 0.0
            
            lettPress.append(userResponse)
            
            if userResponse.lower() =='a': # lOW 
                uResp = 'low'
                response.append(uResp)
                
                
            else:
                uResp = 'high'
                response.append(uResp)
                
                #Something that can be recorded in textfile
                #insert some list or so that can keep tally of how many they get wrong or right for the end 
                # ask eileen if she still wants to tell them what they got wrong/right in the end
                
            if int(digitVal) >= 6: 
                correct = 'high'
                actual.append(correct)
                    
            else:
                correct = 'low'
                actual.append(correct)
            
    if chosenColor == 'Red':                        
        while userResponse not in ['a','l']:
            userResponse=getresponse() 
            
            lettPress.append(userResponse)
            
            currentTime = reactionTime.getTime()
            rTime.append(currentTime)                    
            print(reactionTime) #Changed from print reactionTime to print(reactionTime)
            reactionTime.reset = 0.0
                    
            if userResponse.lower() == 'a': # lOW 
                uResp = 'odd'
                response.append(uResp)
            else:
                uResp = 'even'
                response.append(uResp)
               
            if int(digitVal) % 2 == 0:
                correct = 'even'
                actual.append(correct)
            else:
                correct = 'odd'
                actual.append(correct)
        
        
def showdisplay(tasktype):
    global chosenColor 
    global x
    global y
    global reactionTime

    
    if tasktype.lower() =='p':
        if chosenColor == 'Green' and y <= 5 :
           
            y = y + 1 #Adds to the counter

            taskstore.append('L/H') 
            digitColor = colors[1]
            digitVal = random.choice(numbers)
                
            print(digitVal) #Changed from print digitVal to print(digitVal)
             
            numValue.append(digitVal)
           
            texttodisplay = str(digitVal)
            msg = visual.TextStim(win=mywin, text=texttodisplay, color = digitColor, height = 72.0)
                      
            msg.draw()
            mywin.flip()
            
            reactionTime = core.Clock()
            
            responseCheck(chosenColor, digitVal)
            
            if y == 5:
                y = 0
                chosenColor = 'Red'
            
            reactionTime = 0.0
            blankscreen()
            core.wait(intertrialTime)

        elif chosenColor == 'Red' and x <= 5: 
            x = x + 1 #Adds to the counter

                
            taskstore.append('O/E') 
            digitVal = random.choice(numbers)
            digitColor = colors[0]
                    
            print(digitVal) #Changed from print digitVal to print(digitVal)
            
            numValue.append(digitVal)
            
 
                    
            texttodisplay = str(digitVal)
            msg = visual.TextStim(win=mywin, text=texttodisplay, color = digitColor, height = 72.0 )
                   
            msg.draw()
            mywin.flip()
            
            reactionTime = core.Clock()

            responseCheck(chosenColor, digitVal) 
                          
            if x == 5:
                x = 0
                chosenColor = 'Green'
            
            reactionTime = 0.0
            blankscreen()
            core.wait(intertrialTime)
    elif tasktype.lower() == 'u':

        digitVal = random.choice(numbers)
        digitColor = random.choice(colors)
        
        print(digitVal) #Changed from print digitVal to print(digitVal)
        
        numValue.append(digitVal)
           
        
        chosenColor = digitColor  
        
        if chosenColor == "Green":
            taskstore.append('L/H')
        elif chosenColor == "Red":
            taskstore.append('O/E')
           
            
        texttodisplay = str(digitVal)
        msg = visual.TextStim(win=mywin, text=texttodisplay, color = digitColor, height = 72.0 )
        
        msg.draw()
        mywin.flip()
            
        reactionTime = core.Clock()
        
        responseCheck(chosenColor, digitVal)

        blankscreen()
        core.wait(intertrialTime)
                    



            
            





#The actual experiment running

        
pInstructions = "If numeral is red: \nPress 'A' if odd.\nPress 'L' if even.\nIf numeral is green:\nPress 'A' if less than 5.\nPress 'L' if greater than 5.\nRespond as fast and as accurately as you can."

print(pInstructions) #Changed from print pInstructions to print(pInstructions)
 
          
texttodisplay = str(pInstructions)
msg = visual.TextStim(win=mywin, text=texttodisplay, color = 'White', pos = (-100.0,100.0), height = 30)
msg.draw()                                                      #draw (actually, writes to a buffer)
mywin.flip()                                                    #flip = display now
        
k = ['']
k = event.waitKeys()                                        #psychopy function. wait for button press

chosenColor = random.choice(colors)    
x = 0
y = 0

for i in range(0,ntrials):
    
    showdisplay(tasktype)


for i in range(0,ntrials): #KEEPS TALLY OF CORRECT NUMBERS
    if actual[i] == response[i]:
        endAnswer = endAnswer + 1



endTotal = "You got %s out of %s"%(endAnswer, ntrials)
print(endTotal) #Changed from print endTotal to print(endTotal)
  
texttodisplay = str(endTotal)
msg = visual.TextStim(win=mywin, text=texttodisplay, color = 'White')
msg.draw()                                              
mywin.flip()                                                    

write_file(filename)
mywin.close()
core.quit()













